<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Accessing data in the cloud &#8212; Pangeo CMIP6  documentation</title>
    <link rel="stylesheet" href="_static/pangeo-style.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Cloud data overview" href="overview.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
            <span><img src="_static/small_e_reversed_24px.png"></span>
          Pangeo CMIP6</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Cloud data overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="overview.html#zarr-storage-format">Zarr storage format</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#directory-layout">Directory layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#csv-file-structure">CSV file structure</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accessing data in the cloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#loading-an-esm-collection">Loading an ESM collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#searching-for-datasets">Searching for datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#loading-datasets">Loading datasets</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Accessing data in the cloud</a><ul>
<li><a class="reference internal" href="#loading-an-esm-collection">Loading an ESM collection</a></li>
<li><a class="reference internal" href="#searching-for-datasets">Searching for datasets</a></li>
<li><a class="reference internal" href="#loading-datasets">Loading datasets</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="overview.html" title="Previous Chapter: Cloud data overview"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Cloud data overview</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
            
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="accessing-data-in-the-cloud">
<h1>Accessing data in the cloud<a class="headerlink" href="#accessing-data-in-the-cloud" title="Permalink to this headline">¶</a></h1>
<p>Because of its Zarr format, individual CMIP6 data stores can be accessed using <a class="reference external" href="https://xarray.pydata.org/en/stable/">xarray</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fsspec</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="c1"># gs://cmip6 for data on GCS</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="s2">&quot;s3://cmip6-pds/CMIP/AS-RCEC/TaiESM1/1pctCO2/r1i1p1f1/Amon/hfls/gn/&quot;</span><span class="p">)</span>
<span class="c1"># make sure to specify that metadata is consolidated</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>However, when working with multiple data stores at the same time, it is easier to access them using an Earth System Model (ESM) collection with with <a class="reference external" href="https://intake-esm.readthedocs.io/en/stable/">intake-esm</a>.
This allows the thousands of data stores to be searched and explored using the <a class="reference external" href="https://github.com/WCRP-CMIP/CMIP6_CVs">CMIP6 controlled vocabulary</a>.
When all relevant data stores have been discovered, they can then be merged and opening into an xarray container automatically, using information specified by the ESM collection.</p>
<div class="section" id="loading-an-esm-collection">
<h2>Loading an ESM collection<a class="headerlink" href="#loading-an-esm-collection" title="Permalink to this headline">¶</a></h2>
<p>To load an Earth System Model (ESM) collection with <a class="reference external" href="https://intake-esm.readthedocs.io/en/stable/">intake-esm</a>, the user must provide a valid ESM data catalog as input:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">intake</span>

<span class="n">col</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span><span class="s2">&quot;https://cmip6-pds.s3-us-west-2.amazonaws.com/pangeo-cmip6.json&quot;</span><span class="p">)</span>
<span class="n">col</span>
</pre></div>
</div>
<p>This gives a summary of the ESM collection, including the total number of Zarr data stores (referred to as assets), along with the total number of datasets these Zarr data stores correspond to.
The collection can also be viewed as a <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html">pandas DataFrame</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">col</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="searching-for-datasets">
<h2>Searching for datasets<a class="headerlink" href="#searching-for-datasets" title="Permalink to this headline">¶</a></h2>
<p>After exploring the controlled vocabulary, it’s straightforward to get the data assets you want using intake-esm’s <code class="docutils literal notranslate"><span class="pre">search()</span></code> method.
In the example below, we will search for the following:</p>
<ul class="simple">
<li><p>variables: <code class="docutils literal notranslate"><span class="pre">tas</span></code> which stands for near-surface air temperature</p></li>
<li><p>experiments: <code class="docutils literal notranslate"><span class="pre">[&quot;historical&quot;,</span> <span class="pre">&quot;ssp245&quot;,</span> <span class="pre">&quot;ssp585&quot;]</span></code>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">historical</span></code>: all forcing of the recent past</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssp245</span></code>: update of <a class="reference external" href="https://en.wikipedia.org/wiki/Representative_Concentration_Pathway">RCP4.5</a> based on SSP2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssp585</span></code>: emission-driven <a class="reference external" href="https://en.wikipedia.org/wiki/Representative_Concentration_Pathway">RCP8.5</a> based on SSP5</p></li>
</ul>
</li>
<li><p>table ID: <code class="docutils literal notranslate"><span class="pre">Amon</span></code> which stands for monthly atmospheric data</p></li>
<li><p>grid label: <code class="docutils literal notranslate"><span class="pre">gr</span></code> which stands for regridded data reported on the data provider’s preferred target grid</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># form query dictionary</span>
<span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">experiment_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;historical&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp245&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp585&#39;</span><span class="p">],</span>
             <span class="n">table_id</span><span class="o">=</span><span class="s1">&#39;Amon&#39;</span><span class="p">,</span>
             <span class="n">variable_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span>
             <span class="n">member_id</span> <span class="o">=</span> <span class="s1">&#39;r1i1p1f1&#39;</span><span class="p">,</span>
             <span class="n">grid_label</span><span class="o">=</span><span class="s1">&#39;gr&#39;</span><span class="p">)</span>
<span class="c1"># subset catalog and get some metrics grouped by &#39;source_id&#39;</span>
<span class="n">col_subset</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">require_all_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">query</span><span class="p">)</span>
<span class="n">col_subset</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;variable_id&#39;</span><span class="p">,</span> <span class="s1">&#39;table_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="loading-datasets">
<h2>Loading datasets<a class="headerlink" href="#loading-datasets" title="Permalink to this headline">¶</a></h2>
<p>Once you’ve identified data assets of interest, you can load them into xarray dataset containers using intake-esm’s <code class="docutils literal notranslate"><span class="pre">to_dataset_dict()</span></code> method.
Invoking this method yields a Python dictionary of high-level aggregated xarray datasets.
The logic for merging/concatenating the query results into datasets is provided in the input JSON file, under <code class="docutils literal notranslate"><span class="pre">aggregation_control</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span>&quot;aggregation_control&quot;: {
  &quot;variable_column_name&quot;: &quot;variable_id&quot;,
  &quot;groupby_attrs&quot;: [
    &quot;activity_id&quot;,
    &quot;institution_id&quot;,
    &quot;source_id&quot;,
    &quot;experiment_id&quot;,
    &quot;table_id&quot;,
    &quot;grid_label&quot;
  ],
  &quot;aggregations&quot;: [{
      &quot;type&quot;: &quot;union&quot;,
      &quot;attribute_name&quot;: &quot;variable_id&quot;
    },

    {
      &quot;type&quot;: &quot;join_new&quot;,
      &quot;attribute_name&quot;: &quot;member_id&quot;,
      &quot;options&quot;: {
        &quot;coords&quot;: &quot;minimal&quot;,
        &quot;compat&quot;: &quot;override&quot;
      }
    },
    {
      &quot;type&quot;: &quot;join_new&quot;,
      &quot;attribute_name&quot;: &quot;dcpp_init_year&quot;,
      &quot;options&quot;: {
        &quot;coords&quot;: &quot;minimal&quot;,
        &quot;compat&quot;: &quot;override&quot;
      }
    }
  ]
}
</pre></div>
</div>
<p>Though these aggregation specifications are sufficient to merge individual data assets into xarray datasets, sometimes additional arguments must be provided depending on the format of the data assets.
For example, Zarr-based assets can be loaded with the option <code class="docutils literal notranslate"><span class="pre">consolidated=True</span></code>, which relies on a consolidated metadata file to describe the assets with minimal data egress:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">col_subset</span><span class="o">.</span><span class="n">to_dataset_dict</span><span class="p">(</span><span class="n">zarr_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;consolidated&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                   <span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="s1">&#39;anon&#39;</span><span class="p">})</span>
<span class="c1"># list all merged datasets</span>
<span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dsets</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
</pre></div>
</div>
<p>When the datasets have finished loading, we can extract any of them like we would a value in a Python dictionary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;ScenarioMIP.THU.CIESM.ssp585.Amon.gr&#39;</span><span class="p">]</span>
<span class="n">ds</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020, Pangeo.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>